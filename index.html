<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AV Image Cockpit</title>
<style>
    /* === ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š === */
    :root {
        --bg-main: #050008;
        --panel-bg: #100508;
        --neon-pink: #ff0055;
        --neon-blue: #00d2ff;
        --neon-green: #00ff99;
        --text-color: #eee;
    }
    body { background: var(--bg-main); margin: 0; overflow: hidden; font-family: 'Courier New', sans-serif; color: var(--text-color); user-select: none; }
    
    #container { display: flex; width: 100vw; height: 100vh; }

    /* å·¦å´ï¼šç”»åƒã‚¹ãƒ†ãƒ¼ã‚¸ */
    #image-stage {
        flex: 1; position: relative; background: #000; overflow: hidden;
        border-right: 4px solid var(--neon-pink);
        box-shadow: 0 0 20px rgba(255, 0, 85, 0.2);
        display: flex; justify-content: center; align-items: center;
    }
    
    /* ç”»åƒã®ãƒ•ã‚§ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆç”¨ */
    .slide-img { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        object-fit: contain; opacity: 0; transition: opacity 0.8s ease-in-out; 
    }
    .slide-img.active { opacity: 1; z-index: 10; }
    
    .overlay-guide {
        position: absolute; bottom: 20px; width: 100%; 
        text-align: center; color: rgba(255,255,255,0.4); font-size: 12px; pointer-events: none;
        text-shadow: 0 0 5px #000; z-index: 20;
    }

    /* å³å´ï¼šã‚³ã‚¯ãƒ”ãƒƒãƒˆãƒ‘ãƒãƒ« */
    #cockpit-panel {
        width: 340px; background: var(--panel-bg);
        display: flex; flex-direction: column;
        padding: 10px; box-sizing: border-box;
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 50;
    }

    .panel-section {
        margin-bottom: 10px; border: 1px solid var(--neon-blue);
        background: rgba(0, 20, 30, 0.6); padding: 8px; border-radius: 6px;
        position: relative;
    }
    .title { font-size: 11px; color: var(--neon-blue); margin-bottom: 5px; letter-spacing: 1px; font-weight: bold; }

    /* UIãƒœã‚¿ãƒ³ */
    .btn-group { display: flex; gap: 5px; }
    .btn {
        flex: 1; background: #222; border: 1px solid var(--neon-blue); color: #fff;
        padding: 10px 0; border-radius: 4px; font-weight: bold; cursor: pointer; text-align: center;
        transition: all 0.1s; font-size: 13px;
    }
    .btn-main { background: linear-gradient(135deg, var(--neon-pink), #aa0033); border: none; box-shadow: 0 0 10px var(--neon-pink); }
    .btn-skip { background: #004455; border-color: var(--neon-blue); color: var(--neon-blue); }
    .btn:active { transform: scale(0.96); filter: brightness(1.2); }
    input[type="file"] { display: none; }
    input[type="range"] { width: 100%; accent-color: var(--neon-pink); }

    /* è§£æã‚¹ã‚³ã‚¢è¡¨ç¤º */
    #score-display { 
        font-size: 24px; font-weight: bold; text-align: center; margin: 5px 0; 
        color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green);
    }
    #score-sub { font-size: 10px; text-align: center; color: #888; }

    /* ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¼ */
    .bar-row { display: flex; align-items: center; font-size: 10px; color: #aaa; margin-top: 4px; }
    .bar-label { width: 60px; text-align: right; margin-right: 5px; }
    .bar-track { flex: 1; height: 4px; background: #333; overflow: hidden; border-radius: 2px; }
    .bar-fill { height: 100%; width: 0%; background: #fff; transition: width 0.5s; }

    /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»ãƒãƒ¼ãƒ„ãƒ¬ãƒ¼ãƒ³ */
    #notes-lane-wrap {
        flex: 1; position: relative; overflow: hidden;
        background: linear-gradient(90deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 100%);
        border-top: 2px solid var(--neon-blue);
        border-bottom: 2px solid var(--neon-blue);
        margin-bottom: 10px;
    }
    #notes-canvas { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; }
    
    #hit-line {
        position: absolute; top: 0; left: 60px; width: 4px; height: 100%;
        background: rgba(255, 255, 255, 0.6); z-index: 5;
        box-shadow: 0 0 15px #fff;
    }

    /* æ®‹ã‚Šæ™‚é–“ã‚¿ã‚¤ãƒãƒ¼ */
    #timer-wrap {
        height: 40px; position: relative; background: #000;
        border: 1px solid #444; overflow: hidden; margin-top: 5px;
    }
    #timer-bar { 
        height: 100%; width: 100%; 
        background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink)); 
        transform-origin: left; transition: transform 0.1s linear;
    }

    /* åˆæœŸç”»é¢ */
    #init-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;
        background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .start-btn {
        padding: 20px 60px; font-size: 24px; border-radius: 50px; margin-top: 30px; cursor: pointer;
        background: var(--neon-pink); color: #fff; font-weight: bold; border: 2px solid #fff;
        box-shadow: 0 0 30px var(--neon-pink); animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    
    /* è§£æç”¨ï¼ˆéè¡¨ç¤ºï¼‰ */
    #hidden-canvas { display: none; }
</style>
</head>
<body>

<canvas id="hidden-canvas"></canvas>

<div id="container">
    <div id="image-stage">
        <img id="img1" class="slide-img">
        <img id="img2" class="slide-img">
        <div class="overlay-guide">Double Tap to Fullscreen</div>
    </div>

    <div id="cockpit-panel">
        
        <div class="panel-section">
            <div class="title">SYSTEM CONTROL</div>
            <div class="btn-group">
                <label class="btn btn-main">
                    ğŸ“‚ ADD
                    <input type="file" id="subFileInput" multiple accept="image/*">
                </label>
                <button class="btn btn-skip" onclick="manualSkip()">SKIP â­</button>
            </div>
            
            <div style="margin-top:10px;">
                <div class="bar-row" style="justify-content:space-between; margin-bottom:2px;">
                    <span>BASE DURATION</span>
                    <span id="dur-val" style="color:var(--neon-green)">5.0s</span>
                </div>
                <input type="range" id="duration-slider" min="2" max="10" step="0.5" value="5">
            </div>
        </div>

        <div class="panel-section">
            <div class="title">EROS ANALYSIS</div>
            <div id="score-display">IDLE</div>
            <div id="score-sub">WAITING...</div>
            
            <div class="bar-row">
                <div class="bar-label">SKIN</div>
                <div class="bar-track"><div id="bar-skin" class="bar-fill" style="background:#ffccaa;"></div></div>
            </div>
            <div class="bar-row">
                <div class="bar-label">COMPLEX</div>
                <div class="bar-track"><div id="bar-cplx" class="bar-fill" style="background:#aaeeff;"></div></div>
            </div>
        </div>

        <div class="panel-section">
            <div class="title">NEXT SCAN TIMELINE</div>
            <div id="timer-wrap">
                <div id="timer-bar"></div>
            </div>
        </div>

        <div class="panel-section" style="flex:1; display:flex; flex-direction:column; padding:0; border:none; background:none;">
            <div class="title" style="padding-left:5px;">RHYTHM GUIDE &gt;&gt;&gt;</div>
            <div id="notes-lane-wrap">
                <div id="hit-line"></div>
                <canvas id="notes-canvas"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="init-screen">
    <h1 style="color:var(--neon-pink); text-shadow:0 0 20px var(--neon-pink); font-size:40px; margin:0;">AV IMAGE</h1>
    <div style="color:var(--neon-blue); letter-spacing:4px; margin-bottom:20px;">ANALYSIS COCKPIT</div>
    
    <label class="start-btn">
        ğŸš€ LOAD IMAGES
        <input type="file" id="mainFileInput" multiple accept="image/*">
    </label>
</div>

<script>
    // === è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ===
    const NOTE_SPEED = 6;       // ãƒãƒ¼ãƒ„ã®æ¨ªç§»å‹•é€Ÿåº¦
    const HIT_X = 60;           // åˆ¤å®šãƒ©ã‚¤ãƒ³ã®Xåº§æ¨™

    // === ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•° ===
    const img1 = document.getElementById('img1');
    const img2 = document.getElementById('img2');
    const notesCanvas = document.getElementById('notes-canvas');
    const nCtx = notesCanvas.getContext('2d');
    
    // UIè¦ç´ 
    const scoreDisplay = document.getElementById('score-display');
    const scoreSub = document.getElementById('score-sub');
    const barSkin = document.getElementById('bar-skin');
    const barCplx = document.getElementById('bar-cplx');
    const timerBar = document.getElementById('timer-bar');
    const durSlider = document.getElementById('duration-slider');
    const durVal = document.getElementById('dur-val');
    const initScreen = document.getElementById('init-screen');

    // è§£æç”¨
    const hiddenCanvas = document.getElementById('hidden-canvas');
    const hCtx = hiddenCanvas.getContext('2d', { willReadFrequently: true });

    let playlist = [];
    let notes = [];
    let slideTimer = null;
    let currentImgIndex = 1; // 1 or 2
    
    // ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†ç”¨
    let slideStartTime = 0;
    let slideDuration = 5000;
    
    // ã‚¹ã‚³ã‚¢ç®¡ç†
    let currentScore = 0;

    // === ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ===
    document.getElementById('mainFileInput').addEventListener('change', handleFileSelect);
    document.getElementById('subFileInput').addEventListener('change', handleFileSelect);
    
    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å¤‰æ›´
    durSlider.addEventListener('input', (e) => {
        durVal.innerText = parseFloat(e.target.value).toFixed(1) + "s";
    });

    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        playlist = playlist.concat(files);
        shuffleArray(playlist);
        
        if (initScreen.style.display !== 'none') {
            initScreen.style.display = 'none';
            playNext();
            requestAnimationFrame(renderLoop);
        }
    }

    // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—å…¨ç”»é¢
    let lastTap = 0;
    document.getElementById('image-stage').addEventListener('click', () => {
        const now = new Date().getTime();
        if (now - lastTap < 300) {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
            else if (document.exitFullscreen) document.exitFullscreen();
        }
        lastTap = now;
    });

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // === ãƒ¡ã‚¤ãƒ³ï¼šæ¬¡ã®ç”»åƒã¸ ===
    function playNext() {
        if(playlist.length === 0) return;
        if(slideTimer) clearTimeout(slideTimer);

        const file = playlist.shift();
        playlist.push(file);

        // ç”»åƒã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã¨è§£æé–‹å§‹
        const imgObj = new Image();
        imgObj.src = URL.createObjectURL(file);
        
        imgObj.onload = () => {
            // è§£æå®Ÿè¡Œ
            const analysis = analyzeImage(imgObj);
            
            // UIæ›´æ–°
            updateCockpit(analysis);
            
            // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            const nextImg = currentImgIndex === 1 ? img2 : img1;
            const prevImg = currentImgIndex === 1 ? img1 : img2;
            
            nextImg.src = imgObj.src;
            nextImg.classList.add('active');
            prevImg.classList.remove('active');
            
            currentImgIndex = currentImgIndex === 1 ? 2 : 1;

            // æ¬¡ã®æ™‚é–“æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯
            // ãƒ™ãƒ¼ã‚¹æ™‚é–“ - (ã‚¹ã‚³ã‚¢ãŒé«˜ã„ã»ã©çŸ­ç¸®)
            const baseDur = parseFloat(durSlider.value) * 1000;
            // ã‚¹ã‚³ã‚¢100ãªã‚‰ãƒ™ãƒ¼ã‚¹ã®40%ã®æ™‚é–“ã€ã‚¹ã‚³ã‚¢0ãªã‚‰100%ã®æ™‚é–“
            const nextDur = baseDur - (analysis.totalScore / 100 * (baseDur * 0.6));
            
            slideDuration = nextDur;
            slideStartTime = Date.now();

            // ãƒãƒ¼ãƒ„ç”Ÿæˆ
            spawnNote(analysis.totalScore);

            slideTimer = setTimeout(playNext, slideDuration);
        };
    }

    function manualSkip() {
        playNext();
    }

    // === æ ¸å¿ƒï¼šç”»åƒè§£æãƒ­ã‚¸ãƒƒã‚¯ ===
    function analyzeImage(img) {
        // é‡ããªã‚‰ãªã„ã‚ˆã†ç¸®å°ã—ã¦è§£æ
        const w = 200; 
        const h = 200; // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç„¡è¦–ã§OK
        hiddenCanvas.width = w;
        hiddenCanvas.height = h;
        hCtx.drawImage(img, 0, 0, w, h);
        
        const frame = hCtx.getImageData(0, 0, w, h);
        const data = frame.data;
        const len = data.length;

        let skinPixels = 0;
        let edgeScore = 0;
        
        // 4ãƒ”ã‚¯ã‚»ãƒ«é£›ã°ã—ã§ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆé«˜é€ŸåŒ–ï¼‰
        for(let i = 0; i < len - 4; i += 16) {
            const r = data[i];
            const g = data[i+1];
            const b = data[i+2];
            
            // 1. è‚Œè‰²åˆ¤å®š
            // ç°¡æ˜“ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ : R > G > B ã‹ã¤ Rã¨Gã®å·®ãŒã‚ã‚‹ç¨‹åº¦ã‚ã‚‹
            if (r > 60 && g > 40 && b > 20 && r > g && r > b && Math.abs(r - g) > 10) {
                skinPixels++;
            }

            // 2. è¤‡é›‘åº¦ï¼ˆã‚¨ãƒƒã‚¸ï¼‰åˆ¤å®š
            // éš£ã®ãƒ”ã‚¯ã‚»ãƒ«ã¨ã®è¼åº¦å·®ã‚’è¦‹ã‚‹
            const r2 = data[i+4];
            const g2 = data[i+5];
            const b2 = data[i+6];
            const bri1 = (r+g+b)/3;
            const bri2 = (r2+g2+b2)/3;
            edgeScore += Math.abs(bri1 - bri2);
        }

        const totalPixelsCheck = (len / 4) / 4;
        
        // æ­£è¦åŒ–
        let skinRatio = (skinPixels / totalPixelsCheck) * 100; // 0~100%
        // è‚Œè‰²ã¯èƒŒæ™¯å…¨éƒ¨è‚Œè‰²ã¨ã‹ã‚‚ã‚ã‚‹ã®ã§ã€50%ä»¥ä¸Šã¯é ­æ‰“ã¡ã«ã™ã‚‹ãªã©ã®èª¿æ•´
        if(skinRatio > 80) skinRatio = 80; 

        // è¤‡é›‘åº¦ã¯ç”»åƒã«ã‚ˆã£ã¦é’å¤©äº•ãªã®ã§é©å½“ã«ã‚­ãƒ£ãƒƒãƒ—
        let complexity = (edgeScore / totalPixelsCheck) / 30 * 100; 
        if(complexity > 100) complexity = 100;

        // ç·åˆã‚¹ã‚³ã‚¢: è‚Œè‰²6å‰²ã€è¤‡é›‘åº¦4å‰²
        const total = (skinRatio * 0.6) + (complexity * 0.4);
        
        return {
            skin: skinRatio,
            cplx: complexity,
            totalScore: Math.min(total * 1.5, 100) // ã¡ã‚‡ã£ã¨ãƒ–ãƒ¼ã‚¹ãƒˆ
        };
    }

    // === UIæ›´æ–° ===
    function updateCockpit(res) {
        currentScore = res.totalScore;
        const p = Math.round(currentScore);
        
        scoreDisplay.innerText = `Lv.${p}`;
        scoreSub.innerText = p > 70 ? "HIGH INTENSITY" : (p > 40 ? "NORMAL" : "LOW ACTIVITY");
        
        // è‰²å¤‰åŒ–
        const hue = 180 + (p * 1.8); // é’->èµ¤
        scoreDisplay.style.color = `hsl(${hue}, 100%, 60%)`;

        // ãƒãƒ¼æ›´æ–°
        barSkin.style.width = Math.min(res.skin * 1.5, 100) + "%";
        barCplx.style.width = res.cplx + "%";
    }

    // === ãƒãƒ¼ãƒ„ç”Ÿæˆ ===
    function spawnNote(score) {
        const laneW = notesCanvas.parentElement.clientWidth;
        const laneH = notesCanvas.parentElement.clientHeight;
        
        // ã‚¹ã‚³ã‚¢ãŒé«˜ã„ã»ã©ã€å¤ªãã¦èµ¤ã„ãƒãƒ¼
        const height = laneH * (0.3 + (score/100 * 0.7)); 
        const hue = 180 + (score * 1.8);
        
        notes.push({
            x: laneW + 50,
            y: (laneH - height) / 2,
            width: 30,
            height: height,
            color: `hsl(${hue}, 100%, 60%)`,
            glow: score * 0.5
        });
    }

    // === æç”»ãƒ«ãƒ¼ãƒ— ===
    function renderLoop() {
        requestAnimationFrame(renderLoop);
        
        // Canvasã‚µã‚¤ã‚ºèª¿æ•´
        const p = notesCanvas.parentElement;
        if(notesCanvas.width !== p.clientWidth || notesCanvas.height !== p.clientHeight) {
            notesCanvas.width = p.clientWidth;
            notesCanvas.height = p.clientHeight;
        }

        const W = notesCanvas.width;
        const H = notesCanvas.height;
        nCtx.clearRect(0, 0, W, H);

        // 1. ã‚¿ã‚¤ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const now = Date.now();
        const elapsed = now - slideStartTime;
        let remainRatio = 1.0 - (elapsed / slideDuration);
        if(remainRatio < 0) remainRatio = 0;
        
        timerBar.style.transform = `scaleX(${remainRatio})`;
        
        // è‰²ã‚’æ®‹ã‚Šæ™‚é–“ã§å¤‰ãˆã‚‹ï¼ˆä½™è£•ã‚ã‚Œã°é’ã€ç„¡ã‘ã‚Œã°èµ¤ï¼‰
        const timerHue = remainRatio * 120; // 0=èµ¤, 1=ç·‘
        timerBar.style.background = `hsl(${timerHue}, 100%, 50%)`;

        // 2. ãƒãƒ¼ãƒ„æç”» (æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«)
        const line = document.getElementById('hit-line');

        for (let i = notes.length - 1; i >= 0; i--) {
            const n = notes[i];
            
            // ç§»å‹•é€Ÿåº¦ã‚‚ã‚¹ã‚³ã‚¢ä¾å­˜ã«ã—ãŸã„ãŒã€ç”»åƒåˆ‡ã‚Šæ›¿ãˆã¨åŒæœŸã•ã›ã‚‹ãŸã‚ä¸€å®šã«ã™ã‚‹ã‹ã€
            // ã€Œæ¬¡ã®ç”»åƒãŒå‡ºã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€ã§ãƒ’ãƒƒãƒˆã•ã›ãŸã„ã€‚
            // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œä¸€å®šé€Ÿåº¦ã§æµã‚Œã‚‹é›°å›²æ°—ä½œã‚Šã€ã¨ã™ã‚‹ã€‚
            n.x -= NOTE_SPEED;

            nCtx.shadowBlur = 10 + n.glow;
            nCtx.shadowColor = n.color;
            nCtx.fillStyle = n.color;
            nCtx.globalAlpha = 0.9;
            
            nCtx.beginPath();
            nCtx.roundRect(n.x, n.y, n.width, n.height, 4);
            nCtx.fill();

            // åˆ¤å®šãƒ©ã‚¤ãƒ³é€šéã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            if (n.x < HIT_X && n.x > HIT_X - NOTE_SPEED - 5) {
                line.style.background = n.color;
                line.style.boxShadow = `0 0 30px ${n.color}`;
                setTimeout(() => {
                    line.style.background = 'rgba(255,255,255,0.6)';
                    line.style.boxShadow = '0 0 15px #fff';
                }, 100);
            }

            if (n.x < -50) notes.splice(i, 1);
        }
    }
</script>
</body>
</html>
