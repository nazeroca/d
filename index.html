<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AV Image Cockpit High-Perf</title>
<style>
    /* === ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š === */
    :root {
        --bg-main: #050008;
        --panel-bg: #100508;
        --neon-pink: #ff0055;
        --neon-blue: #00d2ff;
        --neon-green: #00ff99;
        --text-color: #eee;
    }
    body { background: var(--bg-main); margin: 0; overflow: hidden; font-family: 'Courier New', sans-serif; color: var(--text-color); user-select: none; }
    
    #container { display: flex; width: 100vw; height: 100vh; }

    /* å·¦å´ï¼šç”»åƒã‚¹ãƒ†ãƒ¼ã‚¸ */
    #image-stage {
        flex: 1; position: relative; background: #000; overflow: hidden;
        border-right: 4px solid var(--neon-pink);
        box-shadow: 0 0 20px rgba(255, 0, 85, 0.2);
        display: flex; justify-content: center; align-items: center;
    }
    
    .slide-img { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        object-fit: contain; opacity: 0; transition: opacity 0.3s ease-in-out; 
    }
    .slide-img.active { opacity: 1; z-index: 10; }
    
    .overlay-guide {
        position: absolute; bottom: 20px; width: 100%; 
        text-align: center; color: rgba(255,255,255,0.4); font-size: 12px; pointer-events: none;
        text-shadow: 0 0 5px #000; z-index: 20;
    }

    /* å³å´ï¼šã‚³ã‚¯ãƒ”ãƒƒãƒˆãƒ‘ãƒãƒ« */
    #cockpit-panel {
        width: 340px; background: var(--panel-bg);
        display: flex; flex-direction: column;
        padding: 10px; box-sizing: border-box;
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 50;
    }

    .panel-section {
        margin-bottom: 10px; border: 1px solid var(--neon-blue);
        background: rgba(0, 20, 30, 0.6); padding: 8px; border-radius: 6px;
        position: relative;
    }
    .title { font-size: 11px; color: var(--neon-blue); margin-bottom: 5px; letter-spacing: 1px; font-weight: bold; }

    /* UIãƒœã‚¿ãƒ³ */
    .btn-group { display: flex; gap: 5px; }
    .btn {
        flex: 1; background: #222; border: 1px solid var(--neon-blue); color: #fff;
        padding: 10px 0; border-radius: 4px; font-weight: bold; cursor: pointer; text-align: center;
        transition: all 0.1s; font-size: 13px;
        display: flex; align-items: center; justify-content: center;
    }
    .btn-main { background: linear-gradient(135deg, var(--neon-pink), #aa0033); border: none; box-shadow: 0 0 10px var(--neon-pink); }
    .btn-skip { background: #004455; border-color: var(--neon-blue); color: var(--neon-blue); }
    .btn:active { transform: scale(0.96); filter: brightness(1.2); }
    input[type="file"] { display: none; }
    input[type="range"] { width: 100%; accent-color: var(--neon-pink); }

    /* è§£æã‚¹ã‚³ã‚¢è¡¨ç¤º */
    #score-display { 
        font-size: 24px; font-weight: bold; text-align: center; margin: 5px 0; 
        color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green);
    }
    #score-sub { font-size: 10px; text-align: center; color: #888; }

    /* ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¼ */
    .bar-row { display: flex; align-items: center; font-size: 10px; color: #aaa; margin-top: 4px; }
    .bar-label { width: 60px; text-align: right; margin-right: 5px; }
    .bar-track { flex: 1; height: 4px; background: #333; overflow: hidden; border-radius: 2px; }
    .bar-fill { height: 100%; width: 0%; background: #fff; transition: width 0.5s; }

    /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»ãƒãƒ¼ãƒ„ãƒ¬ãƒ¼ãƒ³ */
    #notes-lane-wrap {
        flex: 1; position: relative; overflow: hidden;
        background: linear-gradient(90deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 100%);
        border-top: 2px solid var(--neon-blue);
        border-bottom: 2px solid var(--neon-blue);
        margin-bottom: 10px;
    }
    #notes-canvas { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; }
    
    #hit-line {
        position: absolute; top: 0; left: 60px; width: 4px; height: 100%;
        background: rgba(255, 255, 255, 0.6); z-index: 5;
        box-shadow: 0 0 15px #fff;
    }

    /* æœ€ä½ä¿è¨¼æ™‚é–“ã‚¿ã‚¤ãƒãƒ¼ */
    #timer-wrap {
        height: 6px; position: relative; background: #333;
        border-radius: 3px; overflow: hidden; margin-top: 5px;
    }
    #timer-bar { 
        height: 100%; width: 0%; 
        background: var(--neon-blue); 
        transition: width 0.1s linear;
    }
    #timer-status {
        position: absolute; top: -15px; right: 0; font-size: 9px; color: var(--neon-blue);
    }

    /* åˆæœŸç”»é¢ */
    #init-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;
        background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .start-btn {
        padding: 20px 40px; font-size: 20px; border-radius: 50px; margin-top: 30px; cursor: pointer;
        background: var(--neon-pink); color: #fff; font-weight: bold; border: 2px solid #fff;
        box-shadow: 0 0 30px var(--neon-pink); animation: pulse 1.5s infinite; text-align: center;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    
    /* ãƒ­ãƒ¼ãƒ‰ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #loading-overlay {
        position: fixed; top:0; left:0; width:100%; height:100%; z-index: 1000;
        background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center;
    }
    #loading-bar-wrap { width: 300px; height: 10px; background: #333; border: 1px solid #555; margin-top: 20px; }
    #loading-bar { width: 0%; height: 100%; background: var(--neon-green); transition: width 0.1s; }
    
    #hidden-canvas { display: none; }
</style>
</head>
<body>

<canvas id="hidden-canvas"></canvas>

<div id="loading-overlay">
    <div style="color:var(--neon-green); font-size:20px; font-weight:bold;">LOADING FILES...</div>
    <div id="loading-text" style="color:#aaa; font-size:12px; margin-top:10px;">0 / 0</div>
    <div id="loading-bar-wrap"><div id="loading-bar"></div></div>
</div>

<div id="container">
    <div id="image-stage">
        <img id="img1" class="slide-img">
        <img id="img2" class="slide-img">
        <div class="overlay-guide">Double Tap to Fullscreen</div>
    </div>

    <div id="cockpit-panel">
        <div class="panel-section">
            <div class="title">SYSTEM CONTROL</div>
            <div class="btn-group">
                <label class="btn btn-main">
                    ğŸ“‚ FOLDER
                    <input type="file" id="subFileInput" webkitdirectory directory multiple>
                </label>
                <button class="btn btn-skip" onclick="manualSkip()">SKIP â­</button>
            </div>
            
            <div style="margin-top:15px;">
                <div class="bar-row" style="justify-content:space-between; margin-bottom:2px;">
                    <span>MIN DURATION (WAIT TIME)</span>
                    <span id="dur-val" style="color:var(--neon-green)">5.0s</span>
                </div>
                <input type="range" id="duration-slider" min="2" max="15" step="0.5" value="5">
            </div>
            <div style="font-size:9px; color:#666; margin-top:5px; text-align:center;">
                Loaded: <span id="total-count">0</span> images
            </div>
        </div>

        <div class="panel-section">
            <div class="title">EROS ANALYSIS</div>
            <div id="score-display">IDLE</div>
            <div id="score-sub">WAITING...</div>
            <div class="bar-row">
                <div class="bar-label">SKIN</div>
                <div class="bar-track"><div id="bar-skin" class="bar-fill" style="background:#ffccaa;"></div></div>
            </div>
            <div class="bar-row">
                <div class="bar-label">COMPLEX</div>
                <div class="bar-track"><div id="bar-cplx" class="bar-fill" style="background:#aaeeff;"></div></div>
            </div>
        </div>

        <div class="panel-section">
            <div class="title">TRIGGER STATUS</div>
            <div style="position:relative; margin-top:15px;">
                <div id="timer-status">LOCKED</div>
                <div id="timer-wrap">
                    <div id="timer-bar"></div>
                </div>
            </div>
            <div style="font-size:9px; color:#666; margin-top:5px;">
                * Image changes on first NOTE after unlock
            </div>
        </div>

        <div class="panel-section" style="flex:1; display:flex; flex-direction:column; padding:0; border:none; background:none;">
            <div class="title" style="padding-left:5px;">RHYTHM GUIDE &gt;&gt;&gt;</div>
            <div id="notes-lane-wrap">
                <div id="hit-line"></div>
                <canvas id="notes-canvas"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="init-screen">
    <h1 style="color:var(--neon-pink); text-shadow:0 0 20px var(--neon-pink); font-size:40px; margin:0;">AV IMAGE</h1>
    <div style="color:var(--neon-blue); letter-spacing:4px; margin-bottom:20px;">PERFORMANCE COCKPIT</div>
    <label class="start-btn">
        ğŸ“‚ SELECT FOLDER
        <input type="file" id="mainFileInput" webkitdirectory directory multiple>
    </label>
    <div style="margin-top:20px; color:#666; font-size:12px;">Supports 1000+ Images</div>
</div>

<script>
    // === è¨­å®š ===
    const HIT_X = 60;
    
    // === DOM ===
    const img1 = document.getElementById('img1');
    const img2 = document.getElementById('img2');
    const notesCanvas = document.getElementById('notes-canvas');
    const nCtx = notesCanvas.getContext('2d');
    
    const scoreDisplay = document.getElementById('score-display');
    const scoreSub = document.getElementById('score-sub');
    const barSkin = document.getElementById('bar-skin');
    const barCplx = document.getElementById('bar-cplx');
    
    const timerBar = document.getElementById('timer-bar');
    const timerStatus = document.getElementById('timer-status');
    const durSlider = document.getElementById('duration-slider');
    const durVal = document.getElementById('dur-val');
    const totalCount = document.getElementById('total-count');
    
    const initScreen = document.getElementById('init-screen');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const loadingBar = document.getElementById('loading-bar');
    
    const hiddenCanvas = document.getElementById('hidden-canvas');
    const hCtx = hiddenCanvas.getContext('2d', { willReadFrequently: true });

    // === å¤‰æ•° ===
    let playlist = [];
    let notes = [];
    let currentImgIndex = 1; 
    
    let slideStartTime = 0;
    let minDuration = 5000;
    let isLocked = true;
    let nextNoteTime = 0;
    
    let currentScore = 0;
    let currentInterval = 2000;
    let currentSpeed = 5;

    // === ã‚¤ãƒ™ãƒ³ãƒˆ ===
    // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠå¯¾å¿œ
    document.getElementById('mainFileInput').addEventListener('change', handleFileSelectAsync);
    document.getElementById('subFileInput').addEventListener('change', handleFileSelectAsync);
    
    durSlider.addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        durVal.innerText = val.toFixed(1) + "s";
        minDuration = val * 1000;
    });

    document.getElementById('image-stage').addEventListener('click', () => {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
        else if (document.exitFullscreen) document.exitFullscreen();
    });

    // === éåŒæœŸèª­ã¿è¾¼ã¿å‡¦ç†ï¼ˆ3000æšå¯¾ç­–ï¼‰ ===
    async function handleFileSelectAsync(e) {
        const rawFiles = e.target.files;
        if (rawFiles.length === 0) return;

        // ãƒ­ãƒ¼ãƒ‰ç”»é¢è¡¨ç¤º
        initScreen.style.display = 'none';
        loadingOverlay.style.display = 'flex';
        
        const total = rawFiles.length;
        let loaded = 0;
        let newFiles = [];

        // ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ï¼š500ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«ä¼‘æ†©ã‚’å…¥ã‚Œã¦UIãƒ•ãƒªãƒ¼ã‚ºã‚’é˜²ã
        const CHUNK_SIZE = 500;
        
        for (let i = 0; i < total; i++) {
            // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿æŠ½å‡º
            if (rawFiles[i].type.startsWith('image/')) {
                newFiles.push(rawFiles[i]);
            }
            loaded++;

            // ä¸€å®šæ•°ã”ã¨ã«æç”»æ›´æ–°å¾…ã¡ã‚’å…¥ã‚Œã‚‹
            if (i % CHUNK_SIZE === 0) {
                loadingText.innerText = `${loaded} / ${total}`;
                loadingBar.style.width = (loaded / total * 100) + "%";
                await new Promise(r => setTimeout(r, 0)); // UIã‚¹ãƒ¬ãƒƒãƒ‰ã«åˆ¶å¾¡ã‚’æˆ»ã™
            }
        }

        // å®Œäº†å‡¦ç†
        playlist = playlist.concat(newFiles);
        shuffleArray(playlist); // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚‚ã“ã“ã§
        
        totalCount.innerText = playlist.length;
        loadingOverlay.style.display = 'none';

        // å†ç”Ÿé–‹å§‹
        if (!slideStartTime) { // ã¾ã å§‹ã¾ã£ã¦ãªã‘ã‚Œã°
            playNext();
            requestAnimationFrame(renderLoop);
        }
    }

    function shuffleArray(array) {
        // å¤§é‡é…åˆ—ã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã¯é‡ã„ã®ã§ã€Fisher-Yatesã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§åŠ¹ç‡çš„ã«è¡Œã†
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // === ä»¥é™ã¯åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ ===

    function playNext() {
        if(playlist.length === 0) return;
        
        const file = playlist.shift();
        playlist.push(file); // æœ«å°¾ã¸

        const imgObj = new Image();
        const url = URL.createObjectURL(file);
        imgObj.src = url;
        
        imgObj.onload = () => {
            // ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–: å‰ã®URLã‚’è§£æ”¾ã—ãŸã„ãŒã€img1/2ã§ä½¿ã„å›ã™ã®ã§
            // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«å®Ÿè£…ã€‚å³å¯†ã«ã¯å‰ã®ç”»åƒã®URLã‚’revokeã™ã¹ã
            
            const analysis = analyzeImage(imgObj);
            
            currentScore = analysis.totalScore;
            currentInterval = 5000 - (currentScore / 100 * (5000 - 500));
            currentSpeed = 3 + (currentScore / 100 * 12);

            updateUI(analysis);
            
            const nextImg = currentImgIndex === 1 ? img2 : img1;
            const prevImg = currentImgIndex === 1 ? img1 : img2;
            nextImg.src = imgObj.src;
            nextImg.classList.add('active');
            prevImg.classList.remove('active');
            currentImgIndex = currentImgIndex === 1 ? 2 : 1;

            slideStartTime = Date.now();
            isLocked = true;
            timerBar.style.width = '0%';
            timerStatus.innerText = "LOCKED";
            timerStatus.style.color = "var(--neon-blue)";
            
            nextNoteTime = Date.now() + 500;
        };
    }

    function manualSkip() { playNext(); }

    function analyzeImage(img) {
        const w = 200; const h = 200;
        hiddenCanvas.width = w; hiddenCanvas.height = h;
        hCtx.drawImage(img, 0, 0, w, h);
        const data = hCtx.getImageData(0, 0, w, h).data;

        let skinPixels = 0;
        let edgeScore = 0;
        
        // è§£æã‚‚å°‘ã—é–“å¼•ã„ã¦é«˜é€ŸåŒ–
        const stride = 16; 
        for(let i = 0; i < data.length - 4; i += stride) {
            const r = data[i], g = data[i+1], b = data[i+2];
            if (r > 60 && g > 40 && b > 20 && r > g && r > b && Math.abs(r - g) > 10) skinPixels++;
            
            const bri1 = (r+g+b)/3;
            const bri2 = (data[i+4]+data[i+5]+data[i+6])/3;
            edgeScore += Math.abs(bri1 - bri2);
        }

        const pixels = (data.length / 4) / (stride/4);
        let skin = (skinPixels / pixels) * 100; // é–“å¼•ã„ãŸåˆ†è£œæ­£
        if(skin > 80) skin = 80;
        let cplx = (edgeScore / pixels) / 30 * 100;
        if(cplx > 100) cplx = 100;

        return {
            skin: skin,
            cplx: cplx,
            totalScore: Math.min((skin * 0.6) + (cplx * 0.4) * 1.5, 100)
        };
    }

    function updateUI(res) {
        const p = Math.round(res.totalScore);
        scoreDisplay.innerText = `Lv.${p}`;
        scoreSub.innerText = p > 70 ? "HIGH INTENSITY" : (p > 40 ? "NORMAL" : "LOW ACTIVITY");
        
        const hue = 180 + (p * 1.8);
        scoreDisplay.style.color = `hsl(${hue}, 100%, 60%)`;
        barSkin.style.width = Math.min(res.skin * 1.5, 100) + "%";
        barCplx.style.width = res.cplx + "%";
    }

    function renderLoop() {
        requestAnimationFrame(renderLoop);
        
        const p = notesCanvas.parentElement;
        if(notesCanvas.width !== p.clientWidth || notesCanvas.height !== p.clientHeight) {
            notesCanvas.width = p.clientWidth;
            notesCanvas.height = p.clientHeight;
        }
        const W = notesCanvas.width;
        const H = notesCanvas.height;
        nCtx.clearRect(0, 0, W, H);

        const now = Date.now();
        const elapsed = now - slideStartTime;

        if (isLocked) {
            let progress = (elapsed / minDuration) * 100;
            if (progress >= 100) {
                progress = 100;
                isLocked = false;
                timerStatus.innerText = "READY (NEXT NOTE)";
                timerStatus.style.color = "var(--neon-green)";
                timerBar.style.background = "var(--neon-green)";
            }
            timerBar.style.width = progress + "%";
        }

        if (now > nextNoteTime) {
            spawnNote();
            nextNoteTime = now + currentInterval;
        }

        const line = document.getElementById('hit-line');
        let triggered = false;

        for (let i = notes.length - 1; i >= 0; i--) {
            const n = notes[i];
            n.x -= currentSpeed;

            nCtx.shadowBlur = 10 + n.glow;
            nCtx.shadowColor = n.color;
            nCtx.fillStyle = n.color;
            nCtx.globalAlpha = 0.9;
            nCtx.beginPath();
            nCtx.roundRect(n.x, n.y, n.width, n.height, 4);
            nCtx.fill();

            if (!triggered && !isLocked && n.x < HIT_X && !n.passed) {
                n.passed = true;
                triggered = true;
                
                line.style.background = "var(--neon-green)";
                line.style.boxShadow = "0 0 20px var(--neon-green)";
                setTimeout(()=> line.style.background="rgba(255,255,255,0.6)", 100);

                playNext(); 
            }
            else if (n.x < HIT_X && n.x > HIT_X - currentSpeed - 5 && !n.passed) {
                n.passed = true;
                line.style.background = n.color;
                line.style.boxShadow = `0 0 30px ${n.color}`;
                setTimeout(()=> line.style.background="rgba(255,255,255,0.6)", 100);
            }

            if (n.x < -50) notes.splice(i, 1);
        }
    }

    function spawnNote() {
        const laneH = notesCanvas.height;
        const laneW = notesCanvas.width;
        const score = currentScore;
        const height = laneH * (0.3 + (score/100 * 0.7)); 
        const hue = 180 + (score * 1.8);
        
        notes.push({
            x: laneW + 50,
            y: (laneH - height) / 2,
            width: 20 + (score/100 * 20),
            height: height,
            color: `hsl(${hue}, 100%, 60%)`,
            glow: score * 0.5,
            passed: false
        });
    }
</script>
</body>
</html>
